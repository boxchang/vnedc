{% extends 'mes/base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% block css %}
{% load i18n %}

{% endblock css %}
{% block js %}

<style>

</style>


{% endblock js %}
{% block title %}
Monthly Check
{% endblock title %}
{% block content %}
    <div class="container-fluid mt-3">
        <div class="row d-flex justify-content-center">
            <div class="col-6">
                <div class="card p-4 shadow-sm" id="detailsDialog">
                    <form method="post" id="form">
                        {% crispy form %}
                        <button type="submit" class="btn btn-primary btn-lg">Save</button>
                    </form>
                </div>
            </div>
        </div>
        <table id="jsGrid"></table>

    </div>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>

    <script>
    $(document).ready(function () {
        const deleteUrl = "{% url 'daily_report_delete' %}";

        function renderJsGrid() {
            $("#jsGrid").jsGrid({
                width: "100%",
                height: "700px",

                inserting: false,
                editing: false,
                sorting: true,
                paging: false,
                autoload: true,
                controller:{
                    loadData: function(filter) {
                        console.log("Calling loadData with filter:", filter);
                        return $.ajax({
                            url: "{% url 'daily_report_all' %}",
                            type: "GET",
                            data: filter,
                            dataType: "json",
                            }).then(function(response) {
                                console.log("Dữ liệu từ server:", response);  // Kiểm tra dữ liệu trả về từ server
                                return response.data;  // Chắc chắn trả về đúng phần dữ liệu chứa trong 'data'
                            });
                    },
                },

                fields: [
                    { name: "report_date", type: "date", title: "Date", align: "center" },
                    { name: "comment", type: "text", title: "Comment", align: "center" },
                    {
                        headerTemplate: function() {
                            return $("<button>").attr("type", "button").text("Add")
                                    .on("click", function () {
                                        showDetailsDialog("Add", {'report_date': '', 'comment': ''});
                                    });
                        },
                        modeSwitchButton: false,
                        editButton: false,
                        name: "delete",
                        align: "center",
                        title: "",
                        filtering: false,
                        sorting: false,
                        itemTemplate: function(_, item) {
                            return $("<button>")
                                .text("Delete")
                                .addClass("btn btn-danger btn-sm")
                                .on("click", function () {
                                    if (confirm("Do you want to delete this one?")) {
                                        fetch(deleteUrl, {
                                            method: 'DELETE',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'X-CSRFToken': '{{ csrf_token }}',
                                            },
                                            body: JSON.stringify({
                                                report_date: item.report_date,
                                                comment: item.comment
                                            })
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.status === 'ok') {
                                                alert("Delete successfully!");
                                                $("button[type='submit']").trigger('click');
                                            } else {
                                                alert("Error??");
                                            }
                                        })
                                        .catch(error => {
                                            alert("Error: " + error);
                                        });
                                    }
                                });
                        }
                    },

                ]
            });



            $("#detailsDialog").dialog({
                autoOpen: false,
                width: 400,
                close: function() {
                    const validator = $("#detailsForm").data('validator');
                    if (validator) {
                        validator.resetForm();
                        $("#detailsForm").find(".error").removeClass("error");
                    }
                }
            });



            $("#detailsForm").validate({
                rules: {
                    report_date: "required",
                    comment: { required: true, minlength: 10 },
                },
                messages: {
                    report_date: "Please enter report_date",
                    comment: "Please enter comment",
                },
                submitHandler: function() {
                    formSubmitHandler();
                }
            });

        }

        renderJsGrid();

        let showDetailsDialog = function(dialogType, client) {
            $("#report_date").val(client.report_date);
            $("#comment").val(client.comment);

            formSubmitHandler = function() {
                saveClient(client, dialogType === "Add");
            };

            $("#detailsDialog").dialog("option", "title", dialogType + " Client").dialog("open");
        };


        let saveClient = function(client, isNew) {
            $.extend(client, {
                report_date: $("#report_date").val(),
                comment: $("#comment").val(),
            });

            $("#jsGrid").jsGrid(isNew ? "insertItem" : "updateItem", client);

            $("#detailsDialog").dialog("close");
        };

        $("#form").on("submit", function(e) {
            e.preventDefault();

            $.ajax({
                url: "{% url 'daily_report_comment' %}",
                type: "POST",
                data: $(this).serialize(),
                success: function(response) {
                    $("#id_comment").val('');

                    // Xóa bảng cũ trước khi render lại
                    $("#jsGrid").jsGrid("destroy");

                    // Render lại với dữ liệu mới
                    renderJsGrid(response.data);
                    $("#detailsDialog").dialog("close");
                },
                error: function(xhr) {
                    alert("Lỗi: " + JSON.stringify(xhr.responseJSON));
                }
            });
        });


    });
</script>
{% endblock content %}